<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="contentMapper">

	<resultMap type="content" id="contentResultSet">
		<result column="CON_NO" property="conNo"></result>
		<result column="TABLE_CD" property="tableCd"></result>
		<result column="CON_KTITLE" property="conKTitle"></result>
		<result column="CON_ETITLE" property="conETitle"></result>
		<result column="CON_CATEGORY" property="conCategory"></result>
		<result column="CON_DATE" property="conDate"></result>
		<result column="CON_AGE" property="conAge"></result>
		<result column="CON_INFO" property="conInfo"></result>
		<result column="CON_PREVIEW" property="conPreview"></result>
		<result column="CON_DIRECTOR" property="conDirector"></result>
		<result column="CON_ACTOR" property="conActor"></result>
		<result column="CON_SYNOP" property="conSynop"></result>
		<result column="ENROLL_DATE" property="enrollDate"></result>
		<result column="STATUS" property="status"></result>
	</resultMap>
	<resultMap type="coment" id="commentResultSet">
		<result column="CMT_NO" property="cmtNo"></result>
		<result column="CMT_WRITER" property="cmtWriter"></result>
		<result column="CON_NO" property="conNo"></result>
		<result column="CMT_CONTENT" property="cmtContent"></result>
		<result column="CMT_STAR" property="cmtStar"></result>
		<result column="CREATE_DATE" property="createDate"></result>
		<result column="STATUS" property="status"></result>
		<result column="MEM_NICKNAME" property="memNickname"></result>
	</resultMap>
	<select id="selectList" resultMap="contentResultSet">
		SELECT *
		FROM CONTENT
	</select>
	
	<select id="selectContent" resultMap="contentResultSet">
		SELECT *
		FROM CONTENT
		WHERE CON_NO = #{conNo}
	</select>
	
	<select id="selectGenre" resultType="String">
		SELECT GEN_NAME
		FROM GENRE
		JOIN GENRE_STORAGE S USING (GEN_NO)
		WHERE S.CON_NO = #{conNo}
	</select>
	
	<select id="selectReview" resultMap="commentResultSet">
		SELECT CMT_NO, CMT_WRITER, CON_NO, CMT_CONTENT, CMT_STAR, CREATE_DATE, C.STATUS, MEM_NICKNAME
		FROM COMENT C
		JOIN MEMBER ON (CMT_WRITER = MEM_NO)
		WHERE CON_NO = #{conNo}
	</select>
	
	<insert id="insertReview" parameterType="coment">
		INSERT INTO COMENT(CMT_NO, CMT_WRITER, CON_NO, CMT_CONTENT, CMT_STAR)
		VALUES (SEQ_CMNO.NEXTVAL, #{cmtWriter}, #{conNo}, #{cmtContent}, #{cmtStar})
	</insert>
	
	<select id="selectStar" resultType="double">
		SELECT ROUND(AVG(CMT_STAR/20), 1)
		FROM COMENT
		WHERE CON_NO = #{conNo}
	</select>
	
	<select id="selectContentCategory" parameterType="map" resultMap="contentResultSet">
		<if test="genre.size != 0 and age.size == 0 and ott.size == 0 and category.size == 0">
			SELECT *
			FROM CONTENT
			JOIN GENRE_STORAGE G USING(CON_NO)
			WHERE GEN_NO IN (
			<foreach collection="genre" item="c" separator=",">
				${c}
			</foreach>
			)
		</if>
		
		<if test="genre.size != 0 and age.size != 0 and ott.size == 0 and category.size == 0">
			SELECT *
			FROM CONTENT
			JOIN GENRE_STORAGE G USING(CON_NO)
			WHERE GEN_NO IN (
			<foreach collection="genre" item="c" separator=",">
				${c}
			</foreach>
			) AND CON_AGE IN(
			<foreach collection="age" item="a" separator=",">
				${a}
			</foreach>
			)
		</if>
		
		<if test="genre.size == 0 and age.size != 0 and ott.size == 0 and category.size == 0">
			SELECT *
			FROM CONTENT
			WHERE CON_AGE IN (
			<foreach collection="age" item="a" separator=",">
				${a}
			</foreach>
			)
		</if>
		
		<if test="genre.size == 0 and age.size == 0 and ott.size != 0 and category.size == 0">
			SELECT *
			FROM CONTENT
			JOIN OTT_STORAGE O USING(CON_NO)
			WHERE OTT_NO IN (
			<foreach collection="ott" item="o" separator=",">
				${o}
			</foreach>
			)
		</if>
		
		<if test="genre.size != 0 and age.size == 0 and ott.size != 0 and category.size == 0">
			SELECT *
			FROM CONTENT
			JOIN GENRE_STORAGE G USING(CON_NO)
			JOIN OTT_STORAGE O USING(CON_NO)
			WHERE GEN_NO IN (
			<foreach collection="genre" item="c" separator=",">
				${c}
			</foreach>
			) AND OTT_NO IN (
			<foreach collection="ott" item="o" separator=",">
				${o}
			</foreach>
			) AND 
		</if>
		
		<if test="genre.size == 0 and age.size != 0 and ott.size != 0 and category.size == 0">
			SELECT *
			FROM CONTENT
			JOIN OTT_STORAGE O USING(CON_NO)
			WHERE CON_AGE IN (
			<foreach collection="age" item="a" separator=",">
				${a}
			</foreach>
			) AND OTT_NO IN (
			<foreach collection="ott" item="o" separator=",">
				${o}
			</foreach>
		</if>
		
		<if test="genre.size != 0 and age.size != 0 and ott.size != 0 and category.size == 0">
			SELECT *
			FROM CONTENT
			JOIN GENRE_STORAGE G USING(CON_NO)
			JOIN OTT_STORAGE O USING(CON_NO)
			WHERE GEN_NO IN (
			<foreach collection="genre" item="c" separator=",">
				${c}
			</foreach>
			) AND OTT_NO IN (
			<foreach collection="ott" item="o" separator=",">
				${o}
			</foreach>
			) CON_AGE IN (
			<foreach collection="age" item="a" separator=",">
				${a}
			</foreach>
			)
		</if>
		
		<if test="genre.size != 0 and age.size == 0 and ott.size == 0 and category.size != 0">
			SELECT *
			FROM CONTENT
			JOIN GENRE_STORAGE G USING(CON_NO)
			WHERE GEN_NO IN (
			<foreach collection="genre" item="c" separator=",">
				${c}
			</foreach>
			) AND CON_CATEGORY IN(
			<foreach collection="category" item="g" separator=",">
				${g}
			</foreach>
			)
		</if>
		
		<if test="genre.size != 0 and age.size != 0 and ott.size == 0 and category.size != 0">
			SELECT *
			FROM CONTENT
			JOIN GENRE_STORAGE G USING(CON_NO)
			WHERE GEN_NO IN (
			<foreach collection="genre" item="c" separator=",">
				${c}
			</foreach>
			) AND CON_AGE IN(
			<foreach collection="age" item="a" separator=",">
				${a}
			</foreach>
			) AND CON_CATEGORY IN(
			<foreach collection="category" item="g" separator=",">
				${g}
			</foreach>
			)
		</if>
		
		<if test="genre.size == 0 and age.size != 0 and ott.size == 0 and category.size != 0">
			SELECT *
			FROM CONTENT
			WHERE CON_AGE IN (
			<foreach collection="age" item="a" separator=",">
				${a}
			</foreach>
			) AND CON_CATEGORY IN(
			<foreach collection="category" item="g" separator=",">
				${g}
			</foreach>
			)
		</if>
		
		<if test="genre.size == 0 and age.size == 0 and ott.size != 0 and category.size != 0">
			SELECT *
			FROM CONTENT
			JOIN OTT_STORAGE O USING(CON_NO)
			WHERE OTT_NO IN (
			<foreach collection="ott" item="o" separator=",">
				${o}
			</foreach>
			) AND CON_CATEGORY IN(
			<foreach collection="category" item="g" separator=",">
				${g}
			</foreach>
			)
		</if>
		
		<if test="genre.size != 0 and age.size == 0 and ott.size != 0 and category.size != 0">
			SELECT *
			FROM CONTENT
			JOIN GENRE_STORAGE G USING(CON_NO)
			JOIN OTT_STORAGE O USING(CON_NO)
			WHERE GEN_NO IN (
			<foreach collection="genre" item="c" separator=",">
				${c}
			</foreach>
			) AND OTT_NO IN (
			<foreach collection="ott" item="o" separator=",">
				${o}
			</foreach>
			) AND CON_CATEGORY IN(
			<foreach collection="category" item="g" separator=",">
				${g}
			</foreach>
			)
		</if>
		
		<if test="genre.size == 0 and age.size != 0 and ott.size != 0 and category.size != 0">
			SELECT *
			FROM CONTENT
			JOIN OTT_STORAGE O USING(CON_NO)
			WHERE CON_AGE IN (
			<foreach collection="age" item="a" separator=",">
				${a}
			</foreach>
			) AND OTT_NO IN (
			<foreach collection="ott" item="o" separator=",">
				${o}
			</foreach>
			)
			AND CON_CATEGORY IN(
			<foreach collection="category" item="g" separator=",">
				${g}
			</foreach>
			)
		</if>
		
		<if test="genre.size != 0 and age.size != 0 and ott.size != 0 and category.size != 0">
			SELECT *
			FROM CONTENT
			JOIN GENRE_STORAGE G USING(CON_NO)
			JOIN OTT_STORAGE O USING(CON_NO)
			WHERE GEN_NO IN (
			<foreach collection="genre" item="c" separator=",">
				${c}
			</foreach>
			) AND OTT_NO IN (
			<foreach collection="ott" item="o" separator=",">
				${o}
			</foreach>
			) AND CON_AGE IN (
			<foreach collection="age" item="a" separator=",">
				${a}
			</foreach>
			) AND CON_CATEGORY IN(
			<foreach collection="category" item="g" separator=",">
				${g}
			</foreach>
			)
		</if>
		
		<if test="genre.size == 0 and age.size == 0 and ott.size == 0 and category.size != 0">
			SELECT *
			FROM CONTENT
			WHERE CON_CATEGORY IN(
			<foreach collection="category" item="g" separator=",">
				${g}
			</foreach>
			)
		</if>
		
		<if test="genre.size == 0 and age.size == 0 and ott.size == 0 and category.size == 0">
			SELECT *
			FROM CONTENT
		</if>
			
			
	</select>
</mapper>